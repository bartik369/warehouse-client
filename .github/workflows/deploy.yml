name: üöÄ Deploy Frontend

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: üìù –ó–∞–ø–∏—Å—å .env.production –ª–æ–∫–∞–ª—å–Ω–æ
        run: echo "${{ secrets.ENV_PROD }}" > .env.production

      - name: üì§ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env.production –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: ".env.production"
          target: "/srv/apps/frontend/"

      - name: üöÄ –î–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 50m
          script: |
            echo "===> –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞"
            cd /srv/apps/frontend

            echo "===> –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º .env.production –≤ .env"
            mv .env.production .env

            echo "===> –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è docker-compose.yml"
            if [ ! -f docker-compose.yml ]; then
              echo '–§–∞–π–ª docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω!'
              exit 1
            fi

            echo "===> –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ —Å main"
            git pull origin main

            echo "===> –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
            docker compose down

            echo "===> –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã"
            docker compose build

            echo "===> –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ —Ñ–æ–Ω–µ"
            docker compose up -d

            echo "===> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
            docker compose ps

            echo "===> –í—ã–≤–æ–¥ –ª–æ–≥–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫)"
            docker compose logs --tail=100
